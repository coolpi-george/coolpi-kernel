commit 4d9f49ab3d30f11a1f56f4ea6cac124305797eec
Author: george <george@cool-pi.com>
Date:   Wed Jul 26 16:16:17 2023 +0800

    cm5 notebook typec port and audio switch support

diff --git a/arch/arm64/boot/dts/rockchip/rk3588-cpcm5-notebook.dts b/arch/arm64/boot/dts/rockchip/rk3588-cpcm5-notebook.dts
index 23525b2247e1..823b641071ef 100755
--- a/arch/arm64/boot/dts/rockchip/rk3588-cpcm5-notebook.dts
+++ b/arch/arm64/boot/dts/rockchip/rk3588-cpcm5-notebook.dts
@@ -226,6 +226,24 @@ codec {
 			};
 		};
     };
+	
+	rk_headset: rk-headset {
+		compatible = "rockchip_headset";
+		headset_gpio = <&gpio1 RK_PB5 GPIO_ACTIVE_HIGH>;
+		pinctrl-names = "default";
+		pinctrl-0 = <&hp_det>;
+		io-channels = <&saradc 3>;
+	};
+	
+	dp0_sound: dp0-sound {
+		status = "disabled";
+		compatible = "rockchip,hdmi";
+		rockchip,card-name= "rockchip,dp0";
+		rockchip,mclk-fs = <512>;
+		rockchip,cpu = <&spdif_tx2>;
+		rockchip,codec = <&dp0 1>;
+		rockchip,jack-det;
+	};
 
 	charger: charger {
 		compatible = "gpio-charger";
@@ -363,8 +381,6 @@ vcc5v0_otg: vcc5v0-otg-regulator {
 		regulator-name = "vcc5v0_otg";
 		regulator-min-microvolt = <5000000>;
 		regulator-max-microvolt = <5000000>;
-		regulator-boot-on;
-		regulator-always-on;
 		enable-active-high;
 		gpios = <&gpio0 RK_PA0 GPIO_ACTIVE_HIGH>;
 		vin-supply = <&vcc5v0_sys>;
@@ -422,7 +438,7 @@ i2c_mux: i2c-mux {
 		i2c-gpio,delay-us = <8>;
 		#address-cells = <1>;
 		#size-cells = <0>;
-		status = "okay";
+		status = "disabled";
 	};
 };
 
@@ -620,7 +636,7 @@ &u2phy3 {
 };
 
 &u2phy0_otg {
-	vbus-supply = <&vcc5v0_otg>;
+	rockchip,typec-vbus-det;
 	status = "okay";
 };
 
@@ -656,13 +672,11 @@ &usb_host1_ohci {
 };
 
 &usbdp_phy0 {
-	status = "okay";
-	rockchip,dp-lane-mux = < 0 1 >;
 	orientation-switch;
 	svid = <0xff01>;
 	sbu1-dc-gpios = <&gpio4 RK_PA4 GPIO_ACTIVE_HIGH>;
 	sbu2-dc-gpios = <&gpio4 RK_PA5 GPIO_ACTIVE_HIGH>;
-
+	status = "okay";
 	port {
 		#address-cells = <1>;
 		#size-cells = <0>;
@@ -686,24 +700,12 @@ &usbdp_phy0_u3 {
 	status = "okay";
 };
 
-&usbdp_phy1 {
-	rockchip,dp-lane-mux = < 2 3 >;
-	status = "okay";
-};
-
-&usbdp_phy1_dp {
-	status = "okay";
-};
-
-&usbdp_phy1_u3 {
-	status = "okay";
-};
-
 &usbdrd3_0 {
 	status = "okay";
 };
 
 &usbdrd_dwc3_0 {
+	dr_mode = "otg";
 	status = "okay";
 	usb-role-switch;
 	port {
@@ -716,6 +718,27 @@ dwc3_0_role_switch: endpoint@0 {
 	};
 };
 
+&usbhost3_0 {
+	status = "disabled";
+};
+
+&usbhost_dwc3_0 {
+	status = "disabled";
+};
+
+&usbdp_phy1 {
+	rockchip,dp-lane-mux = < 2 3 >;
+	status = "okay";
+};
+
+&usbdp_phy1_dp {
+	status = "disabled";
+};
+
+&usbdp_phy1_u3 {
+	status = "okay";
+};
+
 &usbdrd3_1 {
 	status = "okay";
 };
@@ -818,6 +841,18 @@ &hdptxphy_hdmi0 {
 	status = "okay";
 };
 
+&dp0 {
+	status = "okay";
+};
+
+&dp0_in_vp1 {
+	status = "okay";
+};
+
+&dp0_sound{
+	status = "okay";
+};
+
 &edp1 {
 	force-hpd;
 	status = "okay";
@@ -1036,16 +1071,16 @@ &i2c7 {
 	es8316: es8316@10 {
 		status = "okay";
 		#sound-dai-cells = <0>;
-		compatible = "everest,es8316";
+		compatible = "everest,es8316-cm5";
 		reg = <0x10>;
 		clocks = <&cru I2S0_8CH_MCLKOUT>;
 		clock-names = "mclk";
 		spk-con-gpio = <&gpio1 RK_PA6 GPIO_ACTIVE_HIGH>;
-		hp-det-gpio = <&gpio1 RK_PB5 GPIO_ACTIVE_HIGH>;
 		assigned-clocks = <&cru I2S0_8CH_MCLKOUT>;
 		assigned-clock-rates = <12288000>;
 		pinctrl-names = "default";
 		pinctrl-0 = <&i2s0_mclk>;
+		extcon = <&rk_headset>;
 	};
 };
 
@@ -1057,6 +1092,10 @@ &i2s0_sdi0
 		     &i2s0_sdo0>;
 };
 
+&spdif_tx2 {
+	status = "okay";
+};
+
 &i2s5_8ch {
 	status = "okay";
 };
@@ -1183,7 +1222,7 @@ usbc0_int: usbc0-int {
 		};
 
 		typec5v_pwren: typec5v-pwren {
-			rockchip,pins = <0 RK_PA0 RK_FUNC_GPIO &pcfg_pull_up>;
+			rockchip,pins = <0 RK_PA0 RK_FUNC_GPIO &pcfg_pull_down>;
 		};
 	};
 
diff --git a/drivers/headset_observe/rk_headset_irq_hook_adc.c b/drivers/headset_observe/rk_headset_irq_hook_adc.c
index d3756430a1aa..70c93debf32c 100644
--- a/drivers/headset_observe/rk_headset_irq_hook_adc.c
+++ b/drivers/headset_observe/rk_headset_irq_hook_adc.c
@@ -81,6 +81,9 @@ extern int rt5631_headset_mic_detect(bool headset_status);
 #if defined(CONFIG_SND_SOC_RT3261) || defined(CONFIG_SND_SOC_RT3224)
 extern int rt3261_headset_mic_detect(int jack_insert);
 #endif
+#ifdef CONFIG_SND_SOC_ES8316_CM5
+extern int es8316_headset_detect(int jack_insert);
+#endif
 
 
 /* headset private data */
@@ -164,7 +167,9 @@ static irqreturn_t headset_interrupt(int irq, void *dev_id)
 	pr_info("(headset in is %s)headset status is %s\n",
 		pdata->headset_insert_type ? "high level" : "low level",
 		headset_info->headset_status ? "in" : "out");
-
+	#ifdef CONFIG_SND_SOC_ES8316_CM5
+		es8316_headset_detect(headset_info->headset_status);
+	#endif
 	if (headset_info->headset_status == HEADSET_IN) {
 		if (pdata->chan != 0) {
 			/* detect Hook key */
@@ -432,7 +437,7 @@ int rk_headset_adc_probe(struct platform_device *pdev,
 		dev_err(&pdev->dev, "failed to register input device\n");
 		goto failed;
 	}
-	input_set_capability(headset->input_dev, EV_KEY, HOOK_KEY_CODE);
+	    input_set_capability(headset->input_dev, EV_KEY, KEY_VOLUMEUP);
 	if (pdata->headset_gpio) {
 		unsigned long irq_type;
 
diff --git a/sound/soc/codecs/es8316-cm5.c b/sound/soc/codecs/es8316-cm5.c
index 874b0b88aa97..b772ec342623 100644
--- a/sound/soc/codecs/es8316-cm5.c
+++ b/sound/soc/codecs/es8316-cm5.c
@@ -1019,12 +1019,17 @@ int es8316_headset_detect(int jack_insert)
 
 	es8316->hp_inserted = jack_insert;
 
-	/*enable micbias and disable PA*/
+	/*Switching MIC channels*/
 	if (jack_insert) {
-		snd_soc_component_update_bits(es8316_component,
-				    ES8316_SYS_PDN_REG0D, 0x3f, 0);
+		snd_soc_component_write(es8316_component,
+				     ES8316_ADC_PDN_LINSEL_REG22, 0x30);
 		es8316_enable_spk(es8316, false);
 	}
+	else{
+		snd_soc_component_write(es8316_component,
+				     ES8316_ADC_PDN_LINSEL_REG22, 0x20);
+		es8316_enable_spk(es8316, true);
+	}
 
 	return 0;
 }
